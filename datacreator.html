<html>
    <head></head>
    <body>
        <div><textarea id="textarea"></textarea></div>
        <button onclick="start(document.getElementById('textarea').value)">process</button>
        <script type="text/javascript">
            
            // Array Extension //
            
            Array.prototype.lastChild = function () {
                return this[this.length - 1];
            }
            
        </script>
        <script type="text/javascript">
            var hymns = new Array();
            
            function start(txt) {
                var p = new Parser(txt);
                var done = false;
                var beginNewHymn = true;
                var beginNewSection = true;
                var consecutiveBlankLines = 0;
                var storeState = "";
                while(!done) {
                    var ln;
                    if(beginNewHymn) {
                        while(true) { // skips remaining empty lines
                            ln = p.nextLine();
                            if(ln != "") break;
                        }
                        
                        var parts = ln.split("   ").filter(isNotBlank);
                        
                        var extractedNum = parts[0].trim();
                        var extractedName = parts[1].trim();
                        
                        var hymn = {number: extractedNum, name: extractedName};
                        hymns.push(hymn);
                        
                        beginNewHymn = false;
                        beginNewSection = true;
                        consecutiveBlankLines = 0;
                    } else {
                        ln = p.nextLine();
                        if(ln == "" || ln == " ") {
                            if(++consecutiveBlankLines > 2) {
                                beginNewHymn = true;
                            } else {
                                beginNewSection = true;
                            }
                        } else if(ln == null) {
                            done = true;
                        } else {
                            ln = ln.trim();
                            if(beginNewSection) {
                                if((new Number(ln)).toString() != "NaN") {
                                    if(hymns.lastChild().verse == undefined) hymns.lastChild().verse = new Array();
                                    hymns.lastChild().verse.push(new Array());
                                    storeState = "verse";
                                } else if(ln == "Refrain") {
                                    if(hymns.lastChild().refrain == undefined) hymns.lastChild().refrain = new Array();
                                    storeState = "refrain";
                                } else {
                                    if(hymns.lastChild().other == undefined) hymns.lastChild().other = new Array();
                                    hymns.lastChild().other.push(new Array());
                                    storeState = "other";
                                }
                                
                                //((new Number(ln)).toString() == "NaN" || ln == "Refrain")
                                beginNewSection = false;
                            } else {
                                switch(storeState)
                                {
                                    case "verse":
                                        //hymns[hymns.length - 1].verse.push(ln);
                                        hymns.lastChild().verse.lastChild().push(ln);
                                        break;
                                    case "refrain":
                                        hymns.lastChild().refrain.push(ln);
                                        //hymns[hymns.length - 1].refrain = ln;
                                        break;
                                    case "other":
                                        hymns.lastChild().other.lastChild().push(ln);
                                        break;
                                }
                            }
                            consecutiveBlankLines = 0;
                        }
                    }
                    
                }
                
            }
            
            
            function Parser(str) 
            {
                this.string = str;
                this.currentLine = 0;
                this.lines = str.split(/[\n\r]/g);
                
                this.nextLine = nextLine;
                function nextLine() {
                    try {
                        var value = this.lines[this.currentLine++];
                    } catch(e) {
                        value = null;
                    }
                    return value;
                }
            }
            
            function isNotBlank(elem) {
                return elem != "";
            }
            
            /*
            while(true) { // skip empty lines
                        ln = p.nextLine();
                        if(ln != "") break;
                    }
                    */
            
            function listAll() {
                for(var g = 0; g < hymns.length; g++) {
                    console.log(hymns[g].number + " " + hymns[g].name);
                }
            }
            
            

/*
var data = new Array();

var file = "/Users/Mac/Desktop/development/SDA Hymnal 2014/SDA Hymnal 2014/resources/text/hymnal-eng.txt";
var allText;
var rawFile = new XMLHttpRequest();
rawFile.open("GET", file, false);
rawFile.onreadystatechange = function ()
{
    if(rawFile.readyState === 4)
    {
        if(rawFile.status === 200 || rawFile.status == 0)
        {
            allText = rawFile.responseText;
        }
    }
}
rawFile.send(null);

start(allText);


function start(txt) {
    var p = new Parser(txt);
    var done = false;
    var beginNewHymn = true;
    var beginNewSection = true;
    var consecutiveBlankLines = 0;
    var storeState = "";
    while(!done) {
        var ln;
        if(beginNewHymn) {
            while(true) { // skips remaining empty lines
                ln = p.nextLine();
                if(ln != "") break;
            }

            var parts = ln.split("   ").filter(isNotBlank);

            var extractedNum = parts[0].trim();
            var extractedName = parts[1].trim();

            var hymn = {number: extractedNum, name: extractedName, category: findCat(extractedNum), subcategory: findSub(extractedNum)};
            data.push(hymn);

            beginNewHymn = false;
            beginNewSection = true;
            consecutiveBlankLines = 0;
        } else {
            ln = p.nextLine();
            if(((ln) ? ln.trim() : ln) == "") {
                if(++consecutiveBlankLines > 2) {
                    beginNewHymn = true;
                } else {
                    beginNewSection = true;
                }
            } else if(ln == null) {
                done = true;
            } else {
                ln = ln.trim();
                if(beginNewSection) {
                    if((new Number(ln)).toString() != "NaN") {
                        if(data.lastChild().verse == undefined) data.lastChild().verse = new Array();
                        data.lastChild().verse.push(new Array());
                        storeState = "verse";
                    } else if(ln == "Refrain") {
                        if(data.lastChild().refrain == undefined) data.lastChild().refrain = new Array();
                        storeState = "refrain";
                    } else if(ln == "Last Refrain") {
                        data.lastChild().last = new Array();
                        storeState = "last";
                    } else {
                        if(data.lastChild().other == undefined) data.lastChild().other = new Array();
                        data.lastChild().other.push(new Array());
                        storeState = "other";
                    }

                    //((new Number(ln)).toString() == "NaN" || ln == "Refrain")
                    beginNewSection = false;
                } else {
                    switch(storeState)
                    {
                        case "verse":
                            //data[data.length - 1].verse.push(ln);
                            data.lastChild().verse.lastChild().push(ln);
                            break;
                        case "refrain":
                            if(data.lastChild().refrain.length == 0) data.lastChild().refrainFirst = (!data.lastChild().verse) ? true : false; // boolean
                            data.lastChild().refrain.push(ln);
                            //data[data.length - 1].refrain = ln;
                            break;
                        case "last":
                            data.lastChild().last.push(ln);
                            break;
                        case "other":
                            data.lastChild().other.lastChild().push(ln);
                            break;
                    }
                }
                consecutiveBlankLines = 0;
            }
        }

    }

}


function Parser(str) 
{
    this.string = str;
    this.currentLine = 0;
    this.lines = str.split(/[\n\r]/g);

    this.nextLine = nextLine;
    function nextLine() {
        try {
            var value = this.lines[this.currentLine++];
        } catch(e) {
            value = null;
        }
        return value;
    }
}

function isNotBlank(elem) {
    return elem != "";
}
*/
        </script>
    </body>
</html>